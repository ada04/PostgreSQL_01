### Урок 11 - Массивы, функции...

#### Array in table


```pgsql
create table tab_arr (
 n serial,
 name varchar(100),
 tel varchar(15) array
 );
```

```pgsql
insert into tab_arr (name,tel) values ('Ivan', array['+79101234567', '+79101234568']);
insert into tab_arr (name,tel) values ('Petr', '{"+79111234567", "+79111234568"}');
```

```pgsql
select * from tab_arr;
```

```pgsql
select * from tab_arr where tel like '%7911%';
select n, name, unnest(tel) from tab_arr where '+79111234567' = any(tel);
```

```pgsql
select * from (
 select n, name, unnest(tel) t from tab_arr)
where t like '%7911%';
```

```pgsql
--drop table tab_arr;
```

#### Function

```pgsql
create or replace function getEmpForTel(p_ar varchar(15)[], sub varchar(15))
returns boolean
as $$
declare
	f boolean := false;
    s varchar(15);
begin
	foreach s in array p_ar loop
       if strpos(s, sub) > 0 then
          f := true;
          exit;
       end if;
    end loop;
    return f;
end $$ language plpgsql;
```

```pgsql
select n, name, unnest(tel) t from tab_arr where getEmpForTel(tel, '7911');
```

#### Function returns table

```pgsql
create or replace function getListTel(p_ar varchar(15)[])
returns table (tel varchar(15))
as $$
declare
  s varchar(15);
begin
  foreach s in array p_ar loop
     tel := s;
     return next;
  end loop;
end $$ language plpgsql;
```

```pgsql
select * from tab_arr where 1 in (select 1 from getListTel(tel) where tel like '%+7910%');
```

#### Function SQL Table

```pgsql
select bp.boarding_no, bp.seat_no, s.fare_conditions, t.passenger_name, t.contact_data -> 'phone' as phone, f.flight_id  
from flights f, ticket_flights tf, tickets t, boarding_passes bp,
     aircrafts a, seats s 
where f.flight_id=tf.flight_id 
  and tf.ticket_no = t.ticket_no 
  and bp.ticket_no = tf.ticket_no
  and bp.flight_id = tf.flight_id
  and f.aircraft_code = a.aircraft_code 
  and a.aircraft_code = s.aircraft_code
  and s.seat_no = bp.seat_no 
  and s.fare_conditions = 'Business'
 ;
```

```pgsql
--161045, 42420, 140798
--drop  function getListPassengers;
```

```pgsql
create or replace function getListPassengers (p_flight_id int4, 
                               p_fare_conditions varchar(20) default null)
returns table (boarding_no int4, seat_no varchar(10), fare_conditions varchar(20), 
               passenger_name varchar(100), phone varchar(100))
as $$
select bp.boarding_no, bp.seat_no, s.fare_conditions, 
       t.passenger_name, t.contact_data -> 'phone' as phone  
from flights f, ticket_flights tf, tickets t, boarding_passes bp, aircrafts a, seats s 
where f.flight_id = tf.flight_id 
  and tf.ticket_no = t.ticket_no 
  and bp.ticket_no = tf.ticket_no
  and bp.flight_id = tf.flight_id
  and f.aircraft_code = a.aircraft_code 
  and a.aircraft_code = s.aircraft_code
  and s.seat_no = bp.seat_no 
  and f.flight_id = p_flight_id
  and ((s.fare_conditions = p_fare_conditions) or (p_fare_conditions is null))
order by fare_conditions, boarding_no
 ;
$$ language sql;
```

```pgsql
select * from getListPassengers(p_flight_id => 161045);
```

```pgsql
select * from getListPassengers(p_flight_id => 42420, p_fare_conditions => 'Business');
```
