

CREATE TABLE boarding_passes (
    ticket_no character(13) NOT NULL,
    flight_id integer NOT NULL,
    boarding_no integer NOT NULL,
    seat_no character varying(4) NOT NULL
);

--# pg_dump -h 192.168.1.130 -p 5432 -d demo -t bookings.boarding_passes --schema-only > boarding_passes_tab.sql 
--# pg_dump -h 192.168.1.130 -p 5432 -d demo -t bookings.boarding_passes --data-only > boarding_passes.sql
--# sed -i -e 's/^COPY bookings/COPY public/' boarding_passes.sql
--# psql -d demo2 < boarding_passes.sql

--# psql -d demo2

\timing

select count(*) from boarding_passes bp ;

select count(*) from boarding_passes bp where seat_no = '22A';

create index boarding_passes_seat_idx on boarding_passes (seat_no);

select count(*) from boarding_passes bp where seat_no = '22A';
select count(*) from boarding_passes bp where upper(seat_no) = '22A';

create index boarding_passes_seatu_idx on boarding_passes (upper(seat_no));

--- TRIGGERS

create [or replace] trigger {имя триггера}
{момент срабатывания} {событие} on {имя таблицы|представления}
[for each row]
[when {условие}]
execute {function|procedure} {имя};

create function {имя()}
returns trigger as $$
[declare
{объявление переменных}]
begin
	{тело функции}
	return new|old|null
end $$ language plpgsql;

---

--drop table log_dml_operations;
--drop trigger log_dml_oper_trg on emp;
--drop function log_dml_oper_func;

create table log_dml_operations (
  id serial,
  username varchar(250),
  command varchar(200),
  data timestamp default now());

create or replace function log_dml_oper_func()
returns trigger as $$
begin 
	insert into log_dml_operations (username, command)
	values (current_user, current_query());
	return null;
end $$ language plpgsql;

create trigger log_dml_oper_trg
after insert or update or delete on emp
execute function log_dml_oper_func();

select * from log_dml_operations ;

insert into emp (name, org_id) values ('Vlad', 1);

select * from emp ;
select * from log_dml_operations ;

update emp set org_id = 2 where name = 'Vlad';

select * from log_dml_operations ;

insert into org(name) values ('Вторая');
select * from org;

update emp set org_id = 2 where name = 'Vlad';

select * from log_dml_operations ;

--

create sequences task_id_seq start with 1 increment by 1;

create table task (
 id varchar(250),
 name varchar(200),
 beg_date timestamp default now(),
 end_date timestamp);

create or replace function task_id_func()
returns trigger as $$
begin 
	select '500-'||nextval('task_id_seq')||'/'||to_char(now(),'YYYY') into STRICT NEW.ID;
	return new;
end $$ language plpgsql;

create trigger task_id_trg
before insert or update or delete on emp
execute function task_id_func();

select * from task;

insert into task (name) values ('Первая');
select * from task;
